<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bear Intake Contract</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <style>
        /* Dropdown select styling */
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 15px;
            background: white;
            color: #333;
            cursor: pointer;
            appearance: auto;
        }
        select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102,126,234,0.2);
        }
        /* Custom item styling */
        .custom-entry-block {
            border: 2px dashed #5cb85c;
            background: #f9fff9;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .custom-entry-block .entry-title {
            color: #3a7a3a;
        }
        .custom-price-badge {
            display: inline-block;
            background: #5cb85c;
            color: white;
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
            font-weight: bold;
            vertical-align: middle;
        }
        .add-custom-btn {
            background: #5cb85c;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            margin-left: 10px;
            transition: background 0.2s;
        }
        .add-custom-btn:hover {
            background: #4cae4c;
        }
        .custom-price-input {
            width: 100%;
            padding: 10px;
            font-size: 18px;
            font-weight: bold;
            border: 2px solid #5cb85c;
            border-radius: 4px;
            background: #e8f5e9;
            color: #2e7d2e;
            box-sizing: border-box;
        }
        .custom-price-input:focus {
            outline: none;
            border-color: #3a7a3a;
        }
    </style>
</head>

<body>
<div id="statusMessage"></div>
<form id="contractForm">
<div class="container">
  <img 
    src="https://images.leadconnectorhq.com/image/f_webp/q_85/r_1000/u_https://storage.googleapis.com/highlevel-backend.appspot.com/location/xzNra69OGYHaxmdDlDMn/form/eDvPanXWhbtHSvXrKdqz/b7d8cff1-2f99-4651-9dd9-f269926c08bb.webp" 
    alt="Company Logo" 
    class="form-logo"
/>
	<h1>Bear Intake Contract</h1>
	<p>Please complete all applicable fields below.</p>

	<h2>Client Information</h2>

	<div class="field-group">
		<label>Sold To</label>
		<input type="text" name="soldTo">
	</div>

	<div class="field-group">
		<label>Phone Number</label>
		<input type="tel" name="phone">
	</div>

	<div class="field-group">
		<label>Email</label>
		<input type="email" name="email">
	</div>

	<div class="field-group">
		<label>Job Site</label>
		<input type="text" name="jobSite">
	</div>

	<h2>Service Details</h2>

	<div class="field-group">
		<label>Type of Service</label>
		<input type="text" name="serviceType">
	</div>

	<div class="field-group">
		<label>Preferred Date</label>
		<input type="date" name="preferredDate">
	</div>

    <h2>Add Items</h2>

	<div id="entries-container"></div>

	<div style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
		<button type="button" class="add-btn" onclick="addEntry()">â• Add Item</button>
		<button type="button" class="add-custom-btn" onclick="addCustomEntry()">âœï¸ Add Custom Item</button>
	</div>

	<!-- Totals Display -->
	<div style="margin-top: 30px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
		<h3 style="margin-top: 0;">Order Summary</h3>
		<div style="display: flex; justify-content: space-between; margin: 10px 0;">
			<strong>Subtotal:</strong>
			<span id="subtotalDisplay">$0.00</span>
		</div>
		<div style="display: flex; justify-content: space-between; margin: 10px 0;">
			<strong>Tax (10.25%):</strong>
			<span id="taxDisplay">$0.00</span>
		</div>
		<div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 20px; border-top: 2px solid #333; padding-top: 10px;">
			<strong>Total:</strong>
			<strong id="totalDisplay">$0.00</strong>
		</div>
	</div>

	<button type="submit">Submit Contract</button>
</div>
</form>
<script>

let entryCount = 0;

function calculatePrice(entryId) {
	const width = parseFloat(document.querySelector(`input[name='width_${entryId}']`).value) || 0;
	const height = parseFloat(document.querySelector(`input[name='height_${entryId}']`).value) || 0;
	const factor = parseFloat(document.querySelector(`input[name='factor_${entryId}']`).value) || 0;
	
	const price = (width + height) * factor;
	document.querySelector(`#price_${entryId}`).textContent = `$${price.toFixed(2)}`;
	
	updateTotals();
}

function updateCustomPrice(entryId) {
	const input = document.querySelector(`input[name='customPrice_${entryId}']`);
	const price = parseFloat(input.value) || 0;
	document.querySelector(`#price_${entryId}`).textContent = `$${price.toFixed(2)}`;
	updateTotals();
}

function updateTotals() {
	let subtotal = 0;
	
	// Sum all price displays (covers both regular and custom entries)
	document.querySelectorAll('[id^="price_"]').forEach(priceEl => {
		const priceValue = parseFloat(priceEl.textContent.replace('$', '')) || 0;
		subtotal += priceValue;
	});
	
	const tax = subtotal * 0.1025;
	const total = subtotal + tax;
	
	document.getElementById('subtotalDisplay').textContent = `$${subtotal.toFixed(2)}`;
	document.getElementById('taxDisplay').textContent = `$${tax.toFixed(2)}`;
	document.getElementById('totalDisplay').textContent = `$${total.toFixed(2)}`;
}

function addEntry() {
	entryCount++;

	const container = document.getElementById("entries-container");
	const entry = document.createElement("div");
	entry.className = "entry-block";
	entry.dataset.entryType = "standard";

	entry.innerHTML = `
    <div class="entry-title">Entry ${entryCount}</div>

    <div class="field-group">
        <label>Qty *</label>
        <input type="number" name="qty_${entryCount}">
    </div>

    <div class="field-group">
        <label>Width *</label>
        <input type="text" name="width_${entryCount}" oninput="calculatePrice(${entryCount})">
    </div>

    <div class="field-group">
        <label>Height *</label>
        <input type="text" name="height_${entryCount}" oninput="calculatePrice(${entryCount})">
    </div>

    <div class="field-group">
        <label>Multiplying factor *</label>
        <input type="text" name="factor_${entryCount}" oninput="calculatePrice(${entryCount})">
    </div>

    <div class="field-group">
        <label>Frame *</label>
        <select name="frame_${entryCount}">
            <option value="">-- Select Frame --</option>
            <option value="Retro-fit">Retro-fit</option>
            <option value="Block frame">Block frame</option>
            <option value="Nail-on">Nail-on</option>
            <option value="Retroluxfin 2.5">Retroluxfin 2.5</option>
        </select>
    </div>

    <div class="field-group">
        <label>Glass Type *</label>
        <select name="glassType_${entryCount}">
            <option value="">-- Select Glass Type --</option>
            <option value="Title 24 package dual pane">Title 24 package dual pane</option>
            <option value="Title 24 package width tempered">Title 24 package width tempered</option>
            <option value="Title 24 package fire zone compliant">Title 24 package fire zone compliant</option>
            <option value="Title 24 package width fire zone glass">Title 24 package width fire zone glass</option>
            <option value="Title 24 package width obscured">Title 24 package width obscured</option>
            <option value="Title 24 package width laminate">Title 24 package width laminate</option>
            <option value="Title 24 package high security glass">Title 24 package high security glass</option>
            <option value="Title 24 package width triple pane">Title 24 package triple pane</option>
        </select>
    </div>

    <div class="field-group">
        <label>Glass Make-up *</label>
        <input type="text" name="glassMakeup_${entryCount}">
    </div>

    <div class="field-group">
        <label>Existing wall type *</label>
        <input type="text" name="wallType_${entryCount}">
    </div>

    <div class="field-group">
        <label>Color (interior/exterior) *</label>
        <input type="text" name="color_${entryCount}">
    </div>

    <div class="field-group">
        <label>Grid *</label>
        <input type="text" name="grid_${entryCount}">
    </div>

    <div class="field-group">
        <label>Room *</label>
        <input type="text" name="room_${entryCount}">
    </div>

    <div class="field-group">
        <label>Price</label>
        <div style="padding: 10px; background: #e8f5e9; border-radius: 4px; font-weight: bold; font-size: 18px;">
            <span id="price_${entryCount}">$0.00</span>
        </div>
    </div>

    <div class="field-group">
        <label>Special notes *</label>
        <textarea name="notes_${entryCount}"></textarea>
    </div>

    <div class="field-group">
        <label>Configuration Exterior View *</label>
        <input type="text" name="configExterior_${entryCount}">
    </div>
    <button type="button" class="duplicate-btn full-width" onclick="duplicateEntry(this)">ğŸ“„ Duplicate Entry</button>
    <button type="button" class="delete-btn full-width" onclick="deleteEntry(this)">ğŸ—‘ï¸ Delete Entry</button>
`;

	container.appendChild(entry);
}

// â”€â”€â”€ NEW: Add Custom Item â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addCustomEntry() {
	entryCount++;

	const container = document.getElementById("entries-container");
	const entry = document.createElement("div");
	entry.className = "custom-entry-block";
	entry.dataset.entryType = "custom";

	entry.innerHTML = `
    <div class="entry-title">
        Custom Item ${entryCount}
        <span class="custom-price-badge">CUSTOM</span>
    </div>

    <div class="field-group">
        <label>Item Name *</label>
        <input type="text" name="customName_${entryCount}" placeholder="e.g. Permit fee, Special hardware...">
    </div>

    <div class="field-group">
        <label>Price ($) *</label>
        <input 
            type="number" 
            name="customPrice_${entryCount}" 
            class="custom-price-input"
            placeholder="0.00" 
            min="0" 
            step="0.01"
            oninput="updateCustomPrice(${entryCount})"
        >
    </div>

    <div class="field-group">
        <label>Price</label>
        <div style="padding: 10px; background: #e8f5e9; border-radius: 4px; font-weight: bold; font-size: 18px;">
            <span id="price_${entryCount}">$0.00</span>
        </div>
    </div>

    <div class="field-group">
        <label>Notes</label>
        <textarea name="customNotes_${entryCount}" placeholder="Optional notes..."></textarea>
    </div>

    <button type="button" class="delete-btn full-width" onclick="deleteEntry(this)">ğŸ—‘ï¸ Delete Custom Item</button>
`;

	container.appendChild(entry);
}
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function deleteEntry(button) {
	button.parentElement.remove();
	updateTotals();
}

function duplicateEntry(button) {
    const original = button.parentElement;
    const clone = original.cloneNode(true);

    entryCount++;

    clone.querySelector(".entry-title").textContent = `Entry ${entryCount}`;

    const fields = clone.querySelectorAll("input, textarea, select");
    fields.forEach(field => {
        const base = field.name.split("_")[0];
        field.name = `${base}_${entryCount}`;
        
        if (base === 'width' || base === 'height' || base === 'factor') {
            field.setAttribute('oninput', `calculatePrice(${entryCount})`);
        }
    });

    const priceDisplay = clone.querySelector('[id^="price_"]');
    priceDisplay.id = `price_${entryCount}`;

    clone.querySelector(".duplicate-btn").onclick = function () {
        duplicateEntry(this);
    };
    clone.querySelector(".delete-btn").onclick = function () {
        deleteEntry(this);
    };

    original.after(clone);
    calculatePrice(entryCount);
}

document.getElementById("contractForm").addEventListener("submit", function(e) {
    e.preventDefault();

    // Validate top-level fields
    const requiredTop = document.querySelectorAll(
        "input[name='soldTo'], input[name='phone'], input[name='email'], input[name='jobSite'], input[name='serviceType'], input[name='preferredDate']"
    );

    for (let field of requiredTop) {
        if (field.value.trim() === "") {
            alert("Please fill out all required fields.");
            field.focus();
            return;
        }
    }

    // Build main JSON object
    const formData = {
        soldTo: document.querySelector("input[name='soldTo']").value,
        phone: document.querySelector("input[name='phone']").value,
        email: document.querySelector("input[name='email']").value,
        jobSite: document.querySelector("input[name='jobSite']").value,
        serviceType: document.querySelector("input[name='serviceType']").value,
        preferredDate: document.querySelector("input[name='preferredDate']").value,
        entries: []
    };

    // Collect dynamic entries
    const allBlocks = document.querySelectorAll(".entry-block, .custom-entry-block");
    if (allBlocks.length === 0) {
        alert("Please add at least one item before submitting.");
        return;
    }

    for (let block of allBlocks) {
        const isCustom = block.dataset.entryType === "custom";
        const priceDisplay = block.querySelector("[id^='price_']").textContent;

        if (isCustom) {
            // â”€â”€ Custom item validation & collection â”€â”€
            const nameField = block.querySelector("input[name^='customName_']");
            const priceField = block.querySelector("input[name^='customPrice_']");

            if (!nameField.value.trim()) {
                alert("Please fill out the item name for all custom items.");
                nameField.focus();
                return;
            }
            if (!priceField.value.trim() || isNaN(parseFloat(priceField.value))) {
                alert("Please enter a valid price for all custom items.");
                priceField.focus();
                return;
            }

            formData.entries.push({
                isCustom: true,
                customName: nameField.value.trim(),
                qty: "1",
                width: "-",
                height: "-",
                factor: "-",
                frame: "-",
                glassType: "-",
                glassMakeup: "-",
                wallType: "-",
                color: "-",
                grid: "-",
                room: "-",
                price: parseFloat(priceField.value).toFixed(2),
                notes: block.querySelector("textarea[name^='customNotes_']").value || "",
                configExterior: "-"
            });

        } else {
            // â”€â”€ Standard item validation & collection â”€â”€
            const entry = {
                isCustom: false,
                qty: block.querySelector("input[name^='qty_']").value,
                width: block.querySelector("input[name^='width_']").value,
                height: block.querySelector("input[name^='height_']").value,
                factor: block.querySelector("input[name^='factor_']").value,
                frame: block.querySelector("select[name^='frame_']").value,
                glassType: block.querySelector("select[name^='glassType_']").value,
                glassMakeup: block.querySelector("input[name^='glassMakeup_']").value,
                wallType: block.querySelector("input[name^='wallType_']").value,
                color: block.querySelector("input[name^='color_']").value,
                grid: block.querySelector("input[name^='grid_']").value,
                room: block.querySelector("input[name^='room_']").value,
                price: priceDisplay.replace('$', ''),
                notes: block.querySelector("textarea[name^='notes_']").value,
                configExterior: block.querySelector("input[name^='configExterior_']").value
            };

            for (let key in entry) {
                if (key !== 'price' && key !== 'isCustom' && entry[key].trim() === "") {
                    alert("Please fill out all fields in each item entry.");
                    return;
                }
            }

            formData.entries.push(entry);
        }
    }

    // Add totals to formData
    formData.subtotal = document.getElementById('subtotalDisplay').textContent.replace('$', '');
    formData.tax = document.getElementById('taxDisplay').textContent.replace('$', '');
    formData.total = document.getElementById('totalDisplay').textContent.replace('$', '');

    console.log("FINAL JSON OBJECT:", formData);

    localStorage.setItem('bearContractData', JSON.stringify(formData));

    const baseUrl = window.location.origin + window.location.pathname.replace('windowform.html', '');
    const pdfLink = baseUrl + 'thank-you.html';

    const formDataToSend = new FormData();
    formDataToSend.append('phone', formData.phone);
    formDataToSend.append('email', formData.email);
    formDataToSend.append('pdfLink', pdfLink);
    formDataToSend.append('soldTo', formData.soldTo);
    formDataToSend.append('jobSite', formData.jobSite);
    formDataToSend.append('serviceType', formData.serviceType);
    formDataToSend.append('preferredDate', formData.preferredDate);
    formDataToSend.append('subtotal', formData.subtotal);
    formDataToSend.append('tax', formData.tax);
    formDataToSend.append('total', formData.total);
    formDataToSend.append('numberOfItems', formData.entries.length);
    formDataToSend.append('submittedAt', new Date().toISOString());

    fetch('https://hooks.zapier.com/hooks/catch/5506897/uea33t4/', {
        method: 'POST',
        body: formDataToSend
    })
    .then(response => {
        console.log('Zapier webhook response:', response);
        window.location.href = 'thank-you.html';
    })
    .catch(error => {
        console.error('Error sending to Zapier:', error);
        window.location.href = 'thank-you.html';
    });
});

</script>

</body>
</html>