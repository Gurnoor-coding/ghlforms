<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bear Intake Contract</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>
<div id="statusMessage"></div>
<form id="contractForm">
<div class="container">
  <img 
    src="https://images.leadconnectorhq.com/image/f_webp/q_85/r_1000/u_https://storage.googleapis.com/highlevel-backend.appspot.com/location/xzNra69OGYHaxmdDlDMn/form/eDvPanXWhbtHSvXrKdqz/b7d8cff1-2f99-4651-9dd9-f269926c08bb.webp" 
    alt="Company Logo" 
    class="form-logo"
/>
	<h1>Bear Intake Contract</h1>
	<p>Please complete all applicable fields below.</p>

	<h2>Client Information</h2>

	<div class="field-group">
		<label>Sold To</label>
		<input type="text" name="soldTo">
	</div>

	<div class="field-group">
		<label>Phone Number</label>
		<input type="tel" name="phone">
	</div>

	<div class="field-group">
		<label>Email</label>
		<input type="email" name="email">
	</div>

	<div class="field-group">
		<label>Job Site</label>
		<input type="text" name="jobSite">
	</div>

	<h2>Service Details</h2>

	<div class="field-group">
		<label>Type of Service</label>
		<input type="text" name="serviceType">
	</div>

	<div class="field-group">
		<label>Preferred Date</label>
		<input type="date" name="preferredDate">
	</div>

    <h2>Add Items</h2>

	<div id="entries-container"></div>

	<button type="button" class="add-btn" onclick="addEntry()">‚ûï Add Item</button>

	<!-- Totals Display -->
	<div style="margin-top: 30px; padding: 20px; background: #f0f0f0; border-radius: 8px;">
		<h3 style="margin-top: 0;">Order Summary</h3>
		<div style="display: flex; justify-content: space-between; margin: 10px 0;">
			<strong>Subtotal:</strong>
			<span id="subtotalDisplay">$0.00</span>
		</div>
		<div style="display: flex; justify-content: space-between; margin: 10px 0;">
			<strong>Tax (10.25%):</strong>
			<span id="taxDisplay">$0.00</span>
		</div>
		<div style="display: flex; justify-content: space-between; margin: 10px 0; font-size: 20px; border-top: 2px solid #333; padding-top: 10px;">
			<strong>Total:</strong>
			<strong id="totalDisplay">$0.00</strong>
		</div>
	</div>

	<button type="submit">Submit Contract</button>
</div>
</form>
<script>

let entryCount = 0;

function calculatePrice(entryId) {
	const width = parseFloat(document.querySelector(`input[name='width_${entryId}']`).value) || 0;
	const height = parseFloat(document.querySelector(`input[name='height_${entryId}']`).value) || 0;
	const factor = parseFloat(document.querySelector(`input[name='factor_${entryId}']`).value) || 0;
	
	const price = (width + height) * factor;
	document.querySelector(`#price_${entryId}`).textContent = `$${price.toFixed(2)}`;
	
	updateTotals();
}

function updateTotals() {
	let subtotal = 0;
	
	// Calculate subtotal from all price displays
	document.querySelectorAll('[id^="price_"]').forEach(priceEl => {
		const priceValue = parseFloat(priceEl.textContent.replace('$', '')) || 0;
		subtotal += priceValue;
	});
	
	const tax = subtotal * 0.1025;
	const total = subtotal + tax;
	
	document.getElementById('subtotalDisplay').textContent = `$${subtotal.toFixed(2)}`;
	document.getElementById('taxDisplay').textContent = `$${tax.toFixed(2)}`;
	document.getElementById('totalDisplay').textContent = `$${total.toFixed(2)}`;
}

function addEntry() {
	entryCount++;

	const container = document.getElementById("entries-container");

	const entry = document.createElement("div");
	entry.className = "entry-block";

	entry.innerHTML = `
    <div class="entry-title">Entry ${entryCount}</div>

    <div class="field-group">
        <label>Qty *</label>
        <input type="number" name="qty_${entryCount}">
    </div>

    <div class="field-group">
        <label>Width *</label>
        <input type="text" name="width_${entryCount}" oninput="calculatePrice(${entryCount})">
    </div>

    <div class="field-group">
        <label>Height *</label>
        <input type="text" name="height_${entryCount}" oninput="calculatePrice(${entryCount})">
    </div>

    <div class="field-group">
        <label>Multiplying factor *</label>
        <input type="text" name="factor_${entryCount}" oninput="calculatePrice(${entryCount})">
    </div>

    <div class="field-group">
        <label>Frame *</label>
        <input type="text" name="frame_${entryCount}">
    </div>

    <div class="field-group">
        <label>Glass Type *</label>
        <input type="text" name="glassType_${entryCount}">
    </div>

    <div class="field-group">
        <label>Glass Make-up *</label>
        <input type="text" name="glassMakeup_${entryCount}">
    </div>

    <div class="field-group">
        <label>Existing wall type *</label>
        <input type="text" name="wallType_${entryCount}">
    </div>

    <div class="field-group">
        <label>Color (interior/exterior) *</label>
        <input type="text" name="color_${entryCount}">
    </div>

    <div class="field-group">
        <label>Grid *</label>
        <input type="text" name="grid_${entryCount}">
    </div>

    <div class="field-group">
        <label>Room *</label>
        <input type="text" name="room_${entryCount}">
    </div>

    <div class="field-group">
        <label>Price</label>
        <div style="padding: 10px; background: #e8f5e9; border-radius: 4px; font-weight: bold; font-size: 18px;">
            <span id="price_${entryCount}">$0.00</span>
        </div>
    </div>

    <div class="field-group">
        <label>Special notes *</label>
        <textarea name="notes_${entryCount}"></textarea>
    </div>

    <div class="field-group">
        <label>Configuration Exterior View *</label>
        <input type="text" name="configExterior_${entryCount}">
    </div>
    <button type="button" class="duplicate-btn full-width" onclick="duplicateEntry(this)">üìÑ Duplicate Entry</button>
    <button type="button" class="delete-btn full-width" onclick="deleteEntry(this)">üóëÔ∏è Delete Entry</button>
`;

	container.appendChild(entry);
}

function deleteEntry(button) {
	button.parentElement.remove();
	updateTotals();
}

function duplicateEntry(button) {
    const original = button.parentElement;
    const clone = original.cloneNode(true);

    // Increase entry count
    entryCount++;

    // Update title
    clone.querySelector(".entry-title").textContent = `Entry ${entryCount}`;

    // Update all input/textarea names and IDs but KEEP values
    const fields = clone.querySelectorAll("input, textarea");
    fields.forEach(field => {
        const base = field.name.split("_")[0];
        field.name = `${base}_${entryCount}`;
        
        // Add oninput handlers for calculation fields
        if (base === 'width' || base === 'height' || base === 'factor') {
            field.setAttribute('oninput', `calculatePrice(${entryCount})`);
        }
    });

    // Update price display ID
    const priceDisplay = clone.querySelector('[id^="price_"]');
    priceDisplay.id = `price_${entryCount}`;

    // Re-bind duplicate + delete buttons
    clone.querySelector(".duplicate-btn").onclick = function () {
        duplicateEntry(this);
    };
    clone.querySelector(".delete-btn").onclick = function () {
        deleteEntry(this);
    };

    // Insert clone after original
    original.after(clone);
    
    // Recalculate price for duplicated entry
    calculatePrice(entryCount);
}

document.getElementById("contractForm").addEventListener("submit", function(e) {
    e.preventDefault();

    // Validate top-level fields
    const requiredTop = document.querySelectorAll(
        "input[name='soldTo'], input[name='phone'], input[name='email'], input[name='jobSite'], input[name='serviceType'], input[name='preferredDate']"
    );

    for (let field of requiredTop) {
        if (field.value.trim() === "") {
            alert("Please fill out all required fields.");
            field.focus();
            return;
        }
    }

    // Build main JSON object
    const formData = {
        soldTo: document.querySelector("input[name='soldTo']").value,
        phone: document.querySelector("input[name='phone']").value,
        email: document.querySelector("input[name='email']").value,
        jobSite: document.querySelector("input[name='jobSite']").value,
        serviceType: document.querySelector("input[name='serviceType']").value,
        preferredDate: document.querySelector("input[name='preferredDate']").value,
        entries: []
    };

    // Collect dynamic entries
    const entryBlocks = document.querySelectorAll(".entry-block");
    if (entryBlocks.length === 0) {
        alert("Please add at least one item before submitting.");
        return;
    }

    for (let block of entryBlocks) {
        const width = block.querySelector("input[name^='width_']").value;
        const height = block.querySelector("input[name^='height_']").value;
        const factor = block.querySelector("input[name^='factor_']").value;
        const priceDisplay = block.querySelector("[id^='price_']").textContent;
        
        const entry = {
            qty: block.querySelector("input[name^='qty_']").value,
            width: width,
            height: height,
            factor: factor,
            frame: block.querySelector("input[name^='frame_']").value,
            glassType: block.querySelector("input[name^='glassType_']").value,
            glassMakeup: block.querySelector("input[name^='glassMakeup_']").value,
            wallType: block.querySelector("input[name^='wallType_']").value,
            color: block.querySelector("input[name^='color_']").value,
            grid: block.querySelector("input[name^='grid_']").value,
            room: block.querySelector("input[name^='room_']").value,
            price: priceDisplay.replace('$', ''),
            notes: block.querySelector("textarea[name^='notes_']").value,
            configExterior: block.querySelector("input[name^='configExterior_']").value
        };

        // Validate entry fields (except price which is calculated)
        for (let key in entry) {
            if (key !== 'price' && entry[key].trim() === "") {
                alert("Please fill out all fields in each entry.");
                return;
            }
        }

        formData.entries.push(entry);
    }

    // Add totals to formData
    formData.subtotal = document.getElementById('subtotalDisplay').textContent.replace('$', '');
    formData.tax = document.getElementById('taxDisplay').textContent.replace('$', '');
    formData.total = document.getElementById('totalDisplay').textContent.replace('$', '');

    console.log("FINAL JSON OBJECT:", formData);

    // Save to localStorage and redirect to thank you page
    localStorage.setItem('bearContractData', JSON.stringify(formData));
    window.location.href = 'thank-you.html';
});

</script>

</body>
</html>